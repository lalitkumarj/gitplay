<html>
<head>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
</head>

<body>


<script>

  var targets = [{"primary_description": "a"}, {"primary_description": "b"}];
  var ranks = [[1, .5, .5, 10], [0, .4, .2, 15]];
  var votes = {"0": {"1 stars": 23, "2 stars": 14, "3 stars": 8, "4 stars": 2}, "1": {"5 stars": 1, "3 stars": 9, "1 stars": 20, "2 stars": 13, "4 stars": 1}};

  function make_csv(targets, ranks, votes) {
    var result, string, columnDelimiter, lineDelimiter;

    var keys = "Rank,Target,T,Î¼,Precision,1 star,2 stars,3 stars,4 stars,5 stars";

    result = "";
    string = keys + "\n";

    columnDelimiter = ",";
    lineDelimieter = "\n";

    for (var i = 0; i < ranks.length; i++) {
      string += [i] + ",";

      // Add captions
      string += "\"" + targets[ranks[i][0]]["primary_description"] + "\",";

      // Add ranks
      string += ranks[i][1] + "," + ranks[i][2] + "," + ranks[i][3] + ",";

      // Add votes
      string += votes[ranks[i][0]]["1 stars"] + "," || 0 + ",";
      string += votes[ranks[i][0]]["2 stars"] + "," || 0 + ",";
      string += votes[ranks[i][0]]["3 stars"] + "," || 0 + ",";
      string += votes[ranks[i][0]]["4 stars"] + "," || 0 + ",";
      string += votes[ranks[i][0]]["5 stars"] + "\n" || 0 + "\n";
    }
    result += string;
    return result;
  }

  var data = make_csv(targets, ranks, votes);
  console.log(data);

  function download_csv() {
    var data, filename, link;
    var csv = make_csv(targets, ranks, votes);

    csv = 'data:text/csv;charset=utf-8,' + csv;
    data = encodeURI(csv);
    filename = "export.csv";

    var link = document.createElement("a");
    link.setAttribute('href', data);
    link.setAttribute('download', filename);
    link.click();

    button.addEventListener("click",download_csv());

    // JQuery stuff
    //$("#download").attr({
    //  'href': data,
    //  'download': filename
    //})

  }

//  function make_csv2() {
//      $("#test_div").html("<b> Hello </b>");
//  }

</script>

<a href='#' onclick='download_csv();'>
  <button type="button" class="btn btn-primary">Download CSV</button>
</a>

<!--
<button onclick="make_csv2()"> Download CSV2 </button>
<div id="test_div"> </div>
-->

</body>

</html>
